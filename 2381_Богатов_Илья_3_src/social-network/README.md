# Social Network — запуск и разработка

Небольшое веб‑приложение на Node.js/Express с серверным рендерингом (EJS), статикой, собираемой через Webpack или Gulp, и файловой БД на NeDB (@seald-io/nedb). Приложение поднимается по HTTPS с самоподписанным сертификатом.

## Стек
- Express 4, EJS
- NeDB (@seald-io/nedb) — хранение в JSON‑файлах в каталоге `db`
- Webpack 5 или Gulp 5 для сборки фронтенда (выбирается через переменную `BUILD`)
- HTTPS (самоподписанный сертификат)

## Требования
- Node.js >= 18, npm >= 9
- OpenSSL (для генерации самоподписанного сертификата)

## Быстрый старт
1. Установить зависимости:
   ```bash
   npm install
   ```
2. Сгенерировать ключ и сертификат (один раз):
   ```bash
   npm run cert
   ```
   Это создаст файлы `social_network.key` и `social_network.csr` в корне проекта (имена берутся из `.env`).
3. Собрать фронтенд:
   - Если в `.env` указано `BUILD=webpack` (по умолчанию):
     ```bash
     npm run webpack
     ```
   - Если хотите использовать Gulp, поставьте в `.env` `BUILD=gulp` и выполните:
     ```bash
     npm run gulp
     ```
4. Запуск сервера:
   ```bash
   npm start
   ```
   По умолчанию сервер слушает `PORT` из `.env` и стартует по HTTPS. Откройте:
   - https://localhost:443  — если порт не меняли

   Примечание: браузер предупредит о самоподписанном сертификате — подтвердите исключение.

## Конфигурация (.env)
Пример (уже есть в репозитории):
```
PORT=443
API_URL=https://localhost:443/api
KEY_FILE=social_network.key
CERT_FILE=social_network.csr
NODE_TLS_REJECT_UNAUTHORIZED=0
DEBUG=social-network:*
DB_DIRNAME=db
USERS_DB=users.json
POSTS_DB=posts.json
# CHATS_DB по умолчанию = chats.json (если не задан)
# Используйте один из вариантов сборки:
BUILD=webpack
```
Пояснения:
- `PORT` — порт HTTPS сервера. Порты <1024 на Linux требуют прав суперпользователя. Если видите ошибку EACCES, используйте, например, `PORT=8443`.
- `API_URL` — URL, на который идут запросы из роутов представлений (`/users`, `/feed`) к REST API (`/api`). Должен совпадать с текущим `PORT`/хостом.
- `KEY_FILE`, `CERT_FILE` — пути к ключу и сертификату для HTTPS.
- `DB_DIRNAME` — каталог, где лежат JSON‑файлы БД (сервер создаст при старте, если нет).
- `USERS_DB`, `POSTS_DB`, `CHATS_DB` — имена файлов коллекций. Если `CHATS_DB` не задан, будет `chats.json`.
- `BUILD` — куда собирать статические файлы: `public/webpack` или `public/gulp`. Сервер раздаёт `public/${BUILD}`.

## Команды npm
- `npm start` — запуск HTTPS‑сервера (`node ./bin/www`).
- `npm run cert` — генерация самоподписанного сертификата (OpenSSL, 2048‑бит, срок 365 дней).
- `npm run webpack` — сборка фронтенда через Webpack в `public/webpack`.
- `npm run gulp` — сборка фронтенда через Gulp в `public/gulp`.

## Тёмная тема
Тема оформлена через переопределение переменных Bootstrap в `scss/style.scss` (до импорта Bootstrap). Цвета фона/текста/карточек и сайдбар — в тёмной палитре. После изменения SCSS выполните `npm run webpack` и обновите страницу.

## Искусственная активность
- Скрипт для наполнения данных: `npm run seed`
  - Создаёт пользователей, связи подписок и несколько постов.
- Скрипт симуляции активности: `npm run activity`
  - Периодически создаёт новые посты от случайных пользователей и добавляет реакции.
  - Интервал задаётся переменной окружения `ACTIVITY_INTERVAL_MS` (по умолчанию 15000 мс), можно передать при запуске:
    ```bash
    ACTIVITY_INTERVAL_MS=10000 npm run activity
    ```
Оба скрипта безопасны для локальной разработки и используют файловую БД `db/*.json`.

## Структура
- `app.js` — настройка приложения, роуты, статика, EJS.
- `bin/www` — HTTPS‑сервер и хэндлеры ошибок.
- `routes/` — страницы (`/users`, `/feed`, `/api` и т.д.).
- `models/` — обёртки NeDB и схемы.
- `db/` — JSON‑файлы баз (создаются/заполняются при работе).
- `public/webpack` или `public/gulp` — собранные статические файлы.

## Типовой рабочий цикл разработки
1. Изменения в `js/` и `scss/`.
2. Сборка:
   - Webpack: `npm run webpack`
   - Gulp: `npm run gulp`
3. Перезапуск `npm start` при изменениях серверной части.

## Частые проблемы и решения
- EACCES при запуске на `PORT=443`.
  - Решение: смените порт, например `PORT=8443`, и обновите `API_URL` на `https://localhost:8443/api`.
- EADDRINUSE (порт занят).
  - Закройте процесс на этом порту или смените `PORT`.
- 404 на статике (CSS/JS) после запуска.
  - Убедитесь, что сборка выполнена и `BUILD` в `.env` соответствует тому, чем собирали (webpack/gulp).
- Браузер ругается на сертификат.
  - Это ожидаемо для самоподписанного. Подтвердите исключение.

## Безопасность
- Самоподписанные сертификаты подходят только для локальной разработки.
- Не храните реальные секреты в репозитории и `.env`.

---
Если хотите, я могу автоматически установить зависимости, собрать проект и запустить сервер — напишите, можно ли запускать команды в вашем окружении и какой порт предпочитаете.
